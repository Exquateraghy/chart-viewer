<!DOCTYPE html>
<html>
<head>
  <title>Stock Chart Viewer - Lightweight Charts + Yahoo Finance API</title>
  <style>
    #chartContainer {
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body>
  <div id="chartContainer"></div>

  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <script>
    function getURLParam(param) {
      const params = new URLSearchParams(window.location.search);
      return params.get(param);
    }

    async function fetchYahooFinanceData(ticker) {
  const url = `https://apidojo-yahoo-finance-v1.p.rapidapi.com/stock/v2/get-chart?symbol=${ticker}&interval=5m&range=1d&region=US`;

  try {
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'X-RapidAPI-Key': 'b5fe46e312mshf5f3fc4311c126ap14ab3bjsnd574a52c11b4',
        'X-RapidAPI-Host': 'apidojo-yahoo-finance-v1.p.rapidapi.com'
      }
    });

    const rawText = await response.text();
    console.log('Raw API response:', rawText);

    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }

    const data = JSON.parse(rawText);
    return data;
  } catch (error) {
    console.error('Error fetching Yahoo Finance data:', error);
    return null;
  }
}


    function transformDataToCandlesticks(rawData) {
      if (!rawData || !rawData.chart || !rawData.chart.result || !rawData.chart.result[0]) return [];

      const timestamps = rawData.chart.result[0].timestamp;
      const ohlc = rawData.chart.result[0].indicators.quote[0];

      if (!timestamps || !ohlc || !ohlc.open) return [];

      return timestamps.map((ts, index) => ({
        time: new Date(ts * 1000).toISOString().split('T')[0] + 'T' + new Date(ts * 1000).toISOString().split('T')[1].slice(0, 5),
        open: ohlc.open[index],
        high: ohlc.high[index],
        low: ohlc.low[index],
        close: ohlc.close[index]
      })).filter(candle => candle.open && candle.high && candle.low && candle.close);
    }

    async function loadChart(ticker) {
      const container = document.getElementById('chartContainer');

      if (!ticker) {
        container.innerText = 'Please provide a ticker in the URL, e.g., ?ticker=AAPL';
        return;
      }

      container.innerText = 'Loading chart data for ' + ticker.toUpperCase() + ' ...';

      const rawData = await fetchYahooFinanceData(ticker);

      if (!rawData) {
        container.innerText = 'Failed to load data for ticker: ' + ticker.toUpperCase();
        return;
      }

      const candlestickData = transformDataToCandlesticks(rawData);

      if (candlestickData.length === 0) {
        container.innerText = 'No data available for ticker: ' + ticker.toUpperCase();
        return;
      }

      container.innerText = '';

      const chart = LightweightCharts.createChart(container, {
        width: document.body.clientWidth,
        height: 600,
        layout: {
          backgroundColor: '#ffffff',
          textColor: '#000',
        },
        grid: {
          vertLines: {
            color: '#eee',
          },
          horzLines: {
            color: '#eee',
          },
        },
        crosshair: {
          mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
          borderColor: '#ccc',
        },
        timeScale: {
          borderColor: '#ccc',
        },
      });

      const candleSeries = chart.addCandlestickSeries();
      candleSeries.setData(candlestickData);
    }

    window.onload = () => {
      const ticker = getURLParam('ticker');
      loadChart(ticker);
    };
  </script>
</body>
</html>
