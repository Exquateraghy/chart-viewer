<!DOCTYPE html>
<html>
<head>
  <title>Stock Chart Viewer - Lightweight Charts + Yahoo Finance API (Daily)</title>
  <style>
    #chartContainer {
      width: 100%;
      height: 600px;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div id="chartContainer"></div>

  <script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>

  <script>
    function getURLParam(param) {
      const params = new URLSearchParams(window.location.search);
      return params.get(param);
    }

    async function fetchYahooFinanceData(ticker) {
      // Daily data, 6 months range
      const url = `https://apidojo-yahoo-finance-v1.p.rapidapi.com/stock/v2/get-chart?interval=1d&region=US&symbol=${ticker}&range=6mo`;

      try {
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'X-RapidAPI-Key': 'b5fe46e312mshf5f3fc4311c126ap14ab3bjsnd574a52c11b4', // your key here
            'X-RapidAPI-Host': 'apidojo-yahoo-finance-v1.p.rapidapi.com'
          }
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        console.log("Raw API response:", JSON.stringify(data)); // for debugging
        return data;
      } catch (error) {
        console.error('Error fetching Yahoo Finance data:', error);
        return null;
      }
    }

    function transformDataToCandlesticks(rawData) {
      if (
        !rawData ||
        !rawData.chart ||
        !rawData.chart.result ||
        !rawData.chart.result[0]
      ) return [];

      const result = rawData.chart.result[0];
      const timestamps = result.timestamp;
      const quote = result.indicators.quote[0];

      if (!timestamps || !quote || !quote.open) return [];

      return timestamps
        .map((ts, idx) => ({
          time: ts, // Lightweight Charts accepts unix timestamp (seconds) for daily data
          open: quote.open[idx],
          high: quote.high[idx],
          low: quote.low[idx],
          close: quote.close[idx]
        }))
        .filter(candle =>
          candle.open != null &&
          candle.high != null &&
          candle.low != null &&
          candle.close != null
        );
    }

    async function loadChart(ticker) {
      const container = document.getElementById('chartContainer');

      if (!ticker) {
        container.innerText = 'Please provide a ticker in the URL, e.g., ?ticker=AAPL';
        return;
      }

      container.innerText = `Loading daily chart data for ${ticker.toUpperCase()}...`;

      const rawData = await fetchYahooFinanceData(ticker);

      if (!rawData) {
        container.innerText = `Failed to load data for ticker: ${ticker.toUpperCase()}`;
        return;
      }

      const candlestickData = transformDataToCandlesticks(rawData);

      if (candlestickData.length === 0) {
        container.innerText = `No data available for ticker: ${ticker.toUpperCase()}`;
        return;
      }

      container.innerText = ''; // Clear loading text

      const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 600,
        layout: {
          backgroundColor: '#ffffff',
          textColor: '#000',
        },
        grid: {
          vertLines: { color: '#eee' },
          horzLines: { color: '#eee' },
        },
        crosshair: {
          mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
          borderColor: '#ccc',
        },
        timeScale: {
          borderColor: '#ccc',
          timeVisible: true,
          secondsVisible: false,
        },
      });

      const candleSeries = chart.addCandlestickSeries();
      candleSeries.setData(candlestickData);

      window.addEventListener('resize', () => {
        chart.applyOptions({ width: container.clientWidth });
      });
    }

    window.onload = () => {
      const ticker = getURLParam('ticker');
      loadChart(ticker);
    };
  </script>
</body>
</html>
